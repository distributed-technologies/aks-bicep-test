# File: .github/workflows/OIDC_workflow.yml

name: Run Azure Login with OIDC
on:
  workflow_dispatch:

permissions:
      id-token: write
      contents: read
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # The credentials looks like https://github.com/Azure/login#configure-a-service-principal-with-a-secret
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: actions/checkout@v3

      - name: 'Run az deploy cmd'
        run: |
          az deployment group create --resource-group "mht-playground" --template-file 'bicep-templates/aks.bicep' --parameters aks_name="SCCP-${GITHUB_REF_NAME}"

      - name: 'Run az get credentials'
        run: |
          az aks get-credentials --resource-group mht-playground --name SCCP-${GITHUB_REF_NAME}

      - name: 'Run kubectl'
        run: |
          kubectl version
